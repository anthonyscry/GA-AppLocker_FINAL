name: Build PS Only (No EXE/BAT)

# PowerShell-only build - no .exe or .bat files
# Use this if your workplace blocks executables

on:
  push:
    branches: [ master, main, develop, 'claude/**' ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:

env:
  POWERSHELL_TELEMETRY_OPTOUT: 1

jobs:
  build:
    name: Build GA-AppLocker (PS Only)
    runs-on: windows-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create output directory
        shell: pwsh
        run: New-Item -ItemType Directory -Path ./output -Force | Out-Null

      - name: Copy main GUI script
        shell: pwsh
        run: |
          Write-Host "====================================" -ForegroundColor Cyan
          Write-Host "  GA-AppLocker PS-Only Build" -ForegroundColor Cyan
          Write-Host "====================================" -ForegroundColor Cyan

          $guiScript = "./build/GA-AppLocker-GUI-WPF.ps1"
          if (-not (Test-Path $guiScript)) {
            Write-Host "##[error]GUI script not found: $guiScript" -ForegroundColor Red
            exit 1
          }

          Write-Host "Found GUI script: $guiScript" -ForegroundColor Green
          Copy-Item -Path $guiScript -Destination "./output/GA-AppLocker-GUI.ps1" -Force
          Write-Host "Copied to output/GA-AppLocker-GUI.ps1" -ForegroundColor Green

      - name: Copy source modules
        shell: pwsh
        run: |
          if (Test-Path "./src") {
            Copy-Item -Path "./src" -Destination "./output/src" -Recurse -Force
            Write-Host "Copied src modules (for future use)" -ForegroundColor Green
          }

      - name: Copy AaronLocker scripts
        shell: pwsh
        run: |
          if (Test-Path "./AaronLocker-main") {
            Copy-Item -Path "./AaronLocker-main" -Destination "./output/AaronLocker-main" -Recurse -Force
            Write-Host "Copied AaronLocker scripts" -ForegroundColor Green
          } else {
            Write-Host "WARNING: AaronLocker-main not found - AaronLocker Tools page will not work" -ForegroundColor Yellow
          }

      - name: Create run instructions
        shell: pwsh
        run: |
          $content = @(
            "GA-AppLocker Toolkit - How to Run"
            "=================================="
            ""
            "STEP 1: Extract to C:\GA-AppLocker"
            ""
            "STEP 2: Open PowerShell as Administrator"
            ""
            "STEP 3: Run these commands:"
            ""
            "  cd C:\GA-AppLocker"
            "  powershell -NoProfile -ExecutionPolicy Bypass -File GA-AppLocker-GUI.ps1"
            ""
            "NOTES"
            "-----"
            "- Run as Administrator for full functionality"
            "- AppLocker events, GPO deployment, and remote scanning require admin rights"
          ) -join "`r`n"
          $content | Out-File -FilePath "./output/RUN-COMMAND.txt" -Encoding UTF8
          Write-Host "Created RUN-COMMAND.txt" -ForegroundColor Green

      - name: Copy documentation
        shell: pwsh
        run: |
          if (Test-Path "./README.md") {
            Copy-Item -Path "./README.md" -Destination "./output/README.md"
          }

      - name: Upload GA-AppLocker (PS Only)
        uses: actions/upload-artifact@v4
        with:
          name: GA-AppLocker-PS-Only
          path: ./output/
          retention-days: 30
          if-no-files-found: error

      - name: Build Summary
        shell: pwsh
        run: |
          Write-Host "====================================" -ForegroundColor Green
          Write-Host "  PS-ONLY BUILD COMPLETED" -ForegroundColor Green
          Write-Host "====================================" -ForegroundColor Green
          Write-Host "Artifact: GA-AppLocker-PS-Only" -ForegroundColor Cyan
          Write-Host "Contents:" -ForegroundColor Cyan
          Write-Host "  - GA-AppLocker-GUI.ps1 (main app)" -ForegroundColor White
          Write-Host "  - RUN-COMMAND.txt" -ForegroundColor White
          Write-Host "  - README.md" -ForegroundColor White
          Write-Host "  - src/ (modules)" -ForegroundColor White
          Write-Host "  - AaronLocker-main/ (AaronLocker scripts)" -ForegroundColor White
