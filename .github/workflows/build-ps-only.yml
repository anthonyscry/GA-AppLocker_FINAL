name: Build PS Only (No EXE/BAT)

# PowerShell-only build using modular architecture
# Use this if your workplace blocks executables

on:
  push:
    branches: [ master, main, develop, 'claude/**' ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:

env:
  POWERSHELL_TELEMETRY_OPTOUT: 1

jobs:
  build:
    name: Build GA-AppLocker (PS Only - Modular)
    runs-on: windows-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create output directory
        shell: pwsh
        run: New-Item -ItemType Directory -Path ./output -Force | Out-Null

      - name: Copy modular architecture
        shell: pwsh
        run: |
          Write-Host "====================================" -ForegroundColor Cyan
          Write-Host "  GA-AppLocker PS-Only Build" -ForegroundColor Cyan
          Write-Host "  Using Modular Architecture" -ForegroundColor Cyan
          Write-Host "====================================" -ForegroundColor Cyan

          # Verify modular entry point exists
          $entryPoint = "./src/GUI/Main/GA-AppLocker-GUI.ps1"
          if (-not (Test-Path $entryPoint)) {
            Write-Host "##[error]Modular entry point not found: $entryPoint" -ForegroundColor Red
            exit 1
          }
          Write-Host "Found modular entry point: $entryPoint" -ForegroundColor Green

          # Copy entire src folder (contains modular GUI architecture)
          Copy-Item -Path "./src" -Destination "./output/src" -Recurse -Force
          Write-Host "Copied src/ modular architecture" -ForegroundColor Green

          # Copy lib folder
          if (Test-Path "./src/lib") {
            Write-Host "  - lib/Common.psm1 (shared library)" -ForegroundColor White
          }

          # Copy config
          if (Test-Path "./src/Config.psm1") {
            Write-Host "  - Config.psm1 (configuration)" -ForegroundColor White
          }

          # List GUI modules
          $guiModules = Get-ChildItem -Path "./src/GUI" -Directory
          foreach ($dir in $guiModules) {
            $fileCount = (Get-ChildItem -Path $dir.FullName -Filter "*.ps1" -Recurse).Count
            Write-Host "  - GUI/$($dir.Name)/ ($fileCount files)" -ForegroundColor White
          }

      - name: Create launcher script
        shell: pwsh
        run: |
          $launcher = @(
            "# GA-AppLocker Launcher"
            "# This script launches the modular GUI application"
            ""
            '$ErrorActionPreference = "Stop"'
            ""
            "# Get the directory where this script is located"
            '$ScriptDir = $PSScriptRoot'
            ""
            "# Path to the modular entry point"
            '$EntryPoint = Join-Path $ScriptDir "src\GUI\Main\GA-AppLocker-GUI.ps1"'
            ""
            'if (-not (Test-Path $EntryPoint)) {'
            '    Write-Host "ERROR: Entry point not found: $EntryPoint" -ForegroundColor Red'
            '    Write-Host "Make sure the src folder is in the same directory as this script." -ForegroundColor Yellow'
            '    Read-Host "Press Enter to exit"'
            "    exit 1"
            "}"
            ""
            "# Launch the application"
            '& $EntryPoint'
          ) -join "`r`n"
          $launcher | Out-File -FilePath "./output/Launch-GA-AppLocker.ps1" -Encoding UTF8
          Write-Host "Created Launch-GA-AppLocker.ps1 launcher" -ForegroundColor Green

      - name: Create run instructions
        shell: pwsh
        run: |
          $content = @(
            "GA-AppLocker Toolkit - How to Run (Modular Version)"
            "===================================================="
            ""
            "This build uses the modular architecture for better maintainability."
            ""
            "STEP 1: Extract to C:\GA-AppLocker (or your preferred location)"
            ""
            "STEP 2: Open PowerShell as Administrator"
            ""
            "STEP 3: Run one of these commands:"
            ""
            "  cd C:\GA-AppLocker"
            "  powershell -NoProfile -ExecutionPolicy Bypass -File Launch-GA-AppLocker.ps1"
            ""
            "  OR directly run the entry point:"
            ""
            "  powershell -NoProfile -ExecutionPolicy Bypass -File src\GUI\Main\GA-AppLocker-GUI.ps1"
            ""
            "NOTES"
            "-----"
            "- Run as Administrator for full functionality"
            "- The modular version loads 39 component files on startup"
            "- First launch may take a few seconds while modules load"
          ) -join "`r`n"
          $content | Out-File -FilePath "./output/RUN-COMMAND.txt" -Encoding UTF8
          Write-Host "Created RUN-COMMAND.txt" -ForegroundColor Green

      - name: Copy documentation
        shell: pwsh
        run: |
          if (Test-Path "./README.md") {
            Copy-Item -Path "./README.md" -Destination "./output/README.md"
          }

      - name: Upload GA-AppLocker (PS Only)
        uses: actions/upload-artifact@v4
        with:
          name: GA-AppLocker-PS-Only
          path: ./output/
          retention-days: 30
          if-no-files-found: error

      - name: Build Summary
        shell: pwsh
        run: |
          Write-Host "====================================" -ForegroundColor Green
          Write-Host "  PS-ONLY BUILD COMPLETED" -ForegroundColor Green
          Write-Host "  Modular Architecture" -ForegroundColor Green
          Write-Host "====================================" -ForegroundColor Green
          Write-Host ""
          Write-Host "Artifact: GA-AppLocker-PS-Only" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Contents:" -ForegroundColor Cyan
          Write-Host "  - Launch-GA-AppLocker.ps1 (launcher)" -ForegroundColor White
          Write-Host "  - RUN-COMMAND.txt (instructions)" -ForegroundColor White
          Write-Host "  - README.md" -ForegroundColor White
          Write-Host "  - src/ (modular architecture)" -ForegroundColor White
          Write-Host "    - GUI/ (39 component files)" -ForegroundColor Gray
          Write-Host "    - lib/ (shared library)" -ForegroundColor Gray
          Write-Host "    - modules/ (7 feature modules)" -ForegroundColor Gray
          Write-Host "    - Config.psm1" -ForegroundColor Gray
