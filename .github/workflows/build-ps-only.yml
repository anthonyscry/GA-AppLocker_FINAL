name: Build PS Only (No EXE/BAT)

# PowerShell-only build - no .exe or .bat files
# Use this if your workplace blocks executables

on:
  push:
    branches: [ master, main, develop, 'claude/**' ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:

env:
  POWERSHELL_TELEMETRY_OPTOUT: 1

jobs:
  build:
    name: Build GA-AppLocker (PS Only)
    runs-on: windows-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create output directory
        shell: pwsh
        run: New-Item -ItemType Directory -Path ./output -Force | Out-Null

      - name: Copy main GUI script
        shell: pwsh
        run: |
          Write-Host "====================================" -ForegroundColor Cyan
          Write-Host "  GA-AppLocker PS-Only Build" -ForegroundColor Cyan
          Write-Host "====================================" -ForegroundColor Cyan

          $guiScript = "./build/GA-AppLocker-GUI-WPF.ps1"
          if (-not (Test-Path $guiScript)) {
            Write-Host "##[error]GUI script not found: $guiScript" -ForegroundColor Red
            exit 1
          }

          Write-Host "Found GUI script: $guiScript" -ForegroundColor Green
          Copy-Item -Path $guiScript -Destination "./output/GA-AppLocker-GUI.ps1" -Force
          Write-Host "Copied to output/GA-AppLocker-GUI.ps1" -ForegroundColor Green

      - name: Copy source modules
        shell: pwsh
        run: |
          if (Test-Path "./src") {
            Copy-Item -Path "./src" -Destination "./output/modules" -Recurse -Force
            Write-Host "Copied src modules" -ForegroundColor Green
          }

      - name: Create run instructions
        shell: pwsh
        run: |
          @"
================================================================================
GA-AppLocker Toolkit - How to Run
================================================================================

Copy and paste one of these commands into PowerShell:

--------------------------------------------------------------------------------
OPTION 1: Run with Windows PowerShell
--------------------------------------------------------------------------------

powershell -NoProfile -ExecutionPolicy Bypass -File "GA-AppLocker-GUI.ps1"

--------------------------------------------------------------------------------
OPTION 2: Run with PowerShell 7 (better performance)
--------------------------------------------------------------------------------

pwsh -NoProfile -ExecutionPolicy Bypass -File "GA-AppLocker-GUI.ps1"

--------------------------------------------------------------------------------
NOTES
--------------------------------------------------------------------------------

- Run as Administrator for full functionality (reading AppLocker events,
  deploying GPO policies, remote computer scanning)

- To run as admin: Right-click PowerShell > "Run as administrator" > paste command

- Make sure you're in the output folder before running
"@ | Out-File -FilePath "./output/RUN-COMMAND.txt" -Encoding UTF8
          Write-Host "Created RUN-COMMAND.txt" -ForegroundColor Green

      - name: Copy documentation
        shell: pwsh
        run: |
          if (Test-Path "./README.md") {
            Copy-Item -Path "./README.md" -Destination "./output/README.md"
          }

      - name: Upload GA-AppLocker (PS Only)
        uses: actions/upload-artifact@v4
        with:
          name: GA-AppLocker-PS-Only
          path: ./output/
          retention-days: 30
          if-no-files-found: error

      - name: Build Summary
        shell: pwsh
        run: |
          Write-Host "====================================" -ForegroundColor Green
          Write-Host "  PS-ONLY BUILD COMPLETED" -ForegroundColor Green
          Write-Host "====================================" -ForegroundColor Green
          Write-Host "Artifact: GA-AppLocker-PS-Only" -ForegroundColor Cyan
          Write-Host "Contents:" -ForegroundColor Cyan
          Write-Host "  - GA-AppLocker-GUI.ps1" -ForegroundColor White
          Write-Host "  - RUN-COMMAND.txt" -ForegroundColor White
          Write-Host "  - modules/ (source)" -ForegroundColor White
          Write-Host "  - README.md" -ForegroundColor White
