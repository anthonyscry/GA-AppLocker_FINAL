name: Build (with Tests)

# Full build workflow with PSScriptAnalyzer and Pester tests
# For fast builds without tests, use build-only.yml (runs on push/PR)

on:
  workflow_dispatch:
    inputs:
      run_slow_tests:
        description: 'Run slow network tests'
        required: false
        default: 'false'
        type: boolean
  schedule:
    # Run full tests weekly on Sunday at midnight
    - cron: '0 0 * * 0'

env:
  POWERSHELL_TELEMETRY_OPTOUT: 1

jobs:
  analyze:
    name: PSScriptAnalyzer
    runs-on: windows-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          Import-Module PSScriptAnalyzer
          $results = Invoke-ScriptAnalyzer -Path ./src -Settings ./PSScriptAnalyzerSettings.psd1 -Recurse
          if ($results) {
            Write-Host "PSScriptAnalyzer found $($results.Count) issue(s):"
            $results | Format-Table -AutoSize
            $errors = $results | Where-Object { $_.Severity -eq 'Error' }
            if ($errors) {
              Write-Host "##[error]Build failed: PSScriptAnalyzer found $($errors.Count) error(s)"
              exit 1
            }
          } else {
            Write-Host "No PSScriptAnalyzer issues found"
          }

  test:
    name: Pester Tests
    runs-on: windows-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Pester
        shell: pwsh
        run: Install-Module -Name Pester -Force -MinimumVersion 5.0 -Scope CurrentUser -SkipPublisherCheck

      - name: Run Pester tests
        shell: pwsh
        run: |
          Import-Module Pester -MinimumVersion 5.0

          $config = New-PesterConfiguration
          $config.Run.Path = "./tests"
          $config.Run.Exit = $false
          $config.Run.Throw = $false
          $config.Output.Verbosity = 'Normal'
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputPath = "./pester-results.xml"
          $config.CodeCoverage.Enabled = $false

          $result = Invoke-Pester -Configuration $config

          Write-Host "`nTest Results:"
          Write-Host "  Passed: $($result.PassedCount)"
          Write-Host "  Failed: $($result.FailedCount)"
          Write-Host "  Skipped: $($result.SkippedCount)"

          if ($result.FailedCount -gt 0) {
            Write-Host "##[error]$($result.FailedCount) tests failed"
            exit 1
          }

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pester-results
          path: pester-results.xml
          retention-days: 30

  build:
    name: Build Package
    needs: [analyze, test]
    runs-on: windows-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create output directory
        shell: pwsh
        run: New-Item -ItemType Directory -Path ./output -Force | Out-Null

      - name: Install PS2EXE
        shell: pwsh
        run: |
          Write-Host "Installing PS2EXE module..."
          Install-Module -Name ps2exe -Force -Scope CurrentUser
          Write-Host "PS2EXE installed successfully"

      - name: Build EXE
        shell: pwsh
        run: |
          Write-Host "====================================" -ForegroundColor Cyan
          Write-Host "  GA-AppLocker Dashboard Build (Tested)" -ForegroundColor Cyan
          Write-Host "====================================" -ForegroundColor Cyan

          $guiScript = "./build/GA-AppLocker-GUI-WPF.ps1"
          if (-not (Test-Path $guiScript)) {
            Write-Host "##[error]GUI script not found: $guiScript" -ForegroundColor Red
            exit 1
          }

          Write-Host "Found GUI script: $guiScript" -ForegroundColor Green
          Copy-Item -Path $guiScript -Destination "./output/GA-AppLocker-GUI.ps1" -Force

          try {
            Import-Module ps2exe
            $exePath = "./output/GA-AppLocker-Dashboard.exe"
            Write-Host "Compiling to EXE..." -ForegroundColor Cyan

            ps2exe -InputFile "./output/GA-AppLocker-GUI.ps1" -OutputFile $exePath -Title "GA-AppLocker Dashboard" -NoConsole -NoOutput

            if (Test-Path $exePath) {
              $size = (Get-Item $exePath).Length / 1MB
              Write-Host "SUCCESS: Built $exePath ($([math]::Round($size, 2)) MB)" -ForegroundColor Green
            } else {
              throw "EXE not created"
            }
          }
          catch {
            Write-Host "PS2EXE compilation failed: $_" -ForegroundColor Yellow
          }

      - name: Copy source modules
        shell: pwsh
        run: |
          if (Test-Path "./src") {
            Copy-Item -Path "./src" -Destination "./output/modules" -Recurse -Force
            Write-Host "Copied src modules" -ForegroundColor Green
          }

      - name: Copy AaronLocker scripts
        shell: pwsh
        run: |
          if (Test-Path "./AaronLocker-main") {
            Copy-Item -Path "./AaronLocker-main" -Destination "./output/AaronLocker-main" -Recurse -Force
            Write-Host "Copied AaronLocker scripts" -ForegroundColor Green
          } else {
            Write-Host "WARNING: AaronLocker-main not found - AaronLocker Tools page will not work" -ForegroundColor Yellow
          }

      - name: Create batch launcher
        shell: pwsh
        run: |
          @'
          @echo off
          title GA-AppLocker Dashboard
          if exist "%~dp0GA-AppLocker-Dashboard.exe" (
            start "" "%~dp0GA-AppLocker-Dashboard.exe"
          ) else if exist "%~dp0GA-AppLocker-GUI.ps1" (
            powershell -NoProfile -ExecutionPolicy Bypass -WindowStyle Hidden -File "%~dp0GA-AppLocker-GUI.ps1"
          ) else (
            echo ERROR: No executable found!
            pause
          )
          '@ | Out-File -FilePath "./output/Launch-GA-AppLocker.bat" -Encoding ASCII
          Write-Host "Created batch launcher" -ForegroundColor Green

      - name: Copy documentation
        shell: pwsh
        run: |
          if (Test-Path "./README.md") {
            Copy-Item -Path "./README.md" -Destination "./output/README.md"
          }

      - name: Upload GA-AppLocker Dashboard (Tested)
        uses: actions/upload-artifact@v4
        with:
          name: GA-AppLocker-Dashboard-Tested
          path: ./output/
          retention-days: 30
          if-no-files-found: error

      - name: Build Summary
        shell: pwsh
        run: |
          Write-Host "====================================" -ForegroundColor Green
          Write-Host "  BUILD WITH TESTS COMPLETED" -ForegroundColor Green
          Write-Host "====================================" -ForegroundColor Green
          Write-Host "All PSScriptAnalyzer checks passed" -ForegroundColor Cyan
          Write-Host "All Pester tests passed" -ForegroundColor Cyan
          Write-Host "Artifact: GA-AppLocker-Dashboard-Tested" -ForegroundColor Cyan
