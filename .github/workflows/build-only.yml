name: Build Only (Priority)

# PRIORITY WORKFLOW - Fast builds without tests
# Runs on every push and PR for quick feedback
# For full testing with PSScriptAnalyzer and Pester, use build.yml

on:
  push:
    branches: [ master, main, develop, 'claude/**' ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:

env:
  POWERSHELL_TELEMETRY_OPTOUT: 1

jobs:
  build:
    name: Build GA-AppLocker
    runs-on: windows-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create output directory
        shell: pwsh
        run: New-Item -ItemType Directory -Path ./output -Force | Out-Null

      - name: Install PS2EXE
        shell: pwsh
        run: |
          Write-Host "Installing PS2EXE module..."
          Install-Module -Name ps2exe -Force -Scope CurrentUser
          Write-Host "PS2EXE installed successfully"

      - name: Build EXE
        shell: pwsh
        run: |
          Write-Host "====================================" -ForegroundColor Cyan
          Write-Host "  GA-AppLocker Dashboard Build" -ForegroundColor Cyan
          Write-Host "====================================" -ForegroundColor Cyan

          $guiScript = "./build/GA-AppLocker-GUI-WPF.ps1"
          if (-not (Test-Path $guiScript)) {
            Write-Host "##[error]GUI script not found: $guiScript" -ForegroundColor Red
            exit 1
          }

          Write-Host "Found GUI script: $guiScript" -ForegroundColor Green
          Copy-Item -Path $guiScript -Destination "./output/GA-AppLocker-GUI.ps1" -Force

          try {
            Import-Module ps2exe
            $exePath = "./output/GA-AppLocker-Dashboard.exe"
            Write-Host "Compiling to EXE..." -ForegroundColor Cyan

            ps2exe -InputFile "./output/GA-AppLocker-GUI.ps1" -OutputFile $exePath -Title "GA-AppLocker Dashboard" -NoConsole -NoOutput

            if (Test-Path $exePath) {
              $size = (Get-Item $exePath).Length / 1MB
              Write-Host "SUCCESS: Built $exePath ($([math]::Round($size, 2)) MB)" -ForegroundColor Green
            } else {
              throw "EXE not created"
            }
          }
          catch {
            Write-Host "PS2EXE compilation failed: $_" -ForegroundColor Yellow
          }

      - name: Copy source modules
        shell: pwsh
        run: |
          if (Test-Path "./src") {
            Copy-Item -Path "./src" -Destination "./output/modules" -Recurse -Force
            Write-Host "Copied src modules" -ForegroundColor Green
          }

      - name: Copy AaronLocker scripts
        shell: pwsh
        run: |
          if (Test-Path "./AaronLocker-main") {
            Copy-Item -Path "./AaronLocker-main" -Destination "./output/AaronLocker-main" -Recurse -Force
            Write-Host "Copied AaronLocker scripts" -ForegroundColor Green

            # Create required subdirectories that may not exist in git
            $aaronLockerPath = "./output/AaronLocker-main/AaronLocker"
            @("Outputs", "ScanResults") | ForEach-Object {
              $subDir = Join-Path $aaronLockerPath $_
              if (-not (Test-Path $subDir)) {
                New-Item -ItemType Directory -Path $subDir -Force | Out-Null
                Write-Host "Created directory: $_" -ForegroundColor Cyan
              }
            }
          } else {
            Write-Host "WARNING: AaronLocker-main not found - AaronLocker Tools page will not work" -ForegroundColor Yellow
          }

      - name: Copy AaronLocker GUI
        shell: pwsh
        run: |
          $aaronLockerGui = "./build/AaronLocker-GUI.ps1"
          if (Test-Path $aaronLockerGui) {
            Copy-Item -Path $aaronLockerGui -Destination "./output/AaronLocker-GUI.ps1" -Force
            Write-Host "Copied AaronLocker GUI" -ForegroundColor Green
          }

      - name: Create batch launchers
        shell: pwsh
        run: |
          # Main GA-AppLocker launcher
          $lines = @(
            "@echo off",
            "title GA-AppLocker Dashboard",
            "if exist `"%~dp0GA-AppLocker-Dashboard.exe`" (",
            "  start `"`" `"%~dp0GA-AppLocker-Dashboard.exe`"",
            ") else if exist `"%~dp0GA-AppLocker-GUI.ps1`" (",
            "  powershell -NoProfile -ExecutionPolicy Bypass -WindowStyle Hidden -File `"%~dp0GA-AppLocker-GUI.ps1`"",
            ") else (",
            "  echo ERROR: No executable found!",
            "  pause",
            ")"
          )
          $lines -join "`r`n" | Out-File -FilePath "./output/Launch-GA-AppLocker.bat" -Encoding ASCII
          Write-Host "Created GA-AppLocker launcher" -ForegroundColor Green

          # AaronLocker GUI launcher
          $aaronLockerBat = @(
            "@echo off",
            "title AaronLocker Tools",
            "if exist `"%~dp0AaronLocker-GUI.ps1`" (",
            "  powershell -NoProfile -ExecutionPolicy Bypass -File `"%~dp0AaronLocker-GUI.ps1`"",
            ") else (",
            "  echo ERROR: AaronLocker-GUI.ps1 not found!",
            "  pause",
            ")"
          )
          $aaronLockerBat -join "`r`n" | Out-File -FilePath "./output/Launch-AaronLocker.bat" -Encoding ASCII
          Write-Host "Created AaronLocker launcher" -ForegroundColor Green

      - name: Copy documentation
        shell: pwsh
        run: |
          if (Test-Path "./README.md") {
            Copy-Item -Path "./README.md" -Destination "./output/README.md"
          }

      - name: Upload GA-AppLocker Dashboard
        uses: actions/upload-artifact@v4
        with:
          name: GA-AppLocker-Dashboard
          path: ./output/
          retention-days: 30
          if-no-files-found: error

      - name: Build Summary
        shell: pwsh
        run: |
          Write-Host "====================================" -ForegroundColor Green
          Write-Host "  BUILD COMPLETED SUCCESSFULLY" -ForegroundColor Green
          Write-Host "====================================" -ForegroundColor Green
          Write-Host "Artifact: GA-AppLocker-Dashboard" -ForegroundColor Cyan
